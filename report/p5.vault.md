# SWH Vault

####

Le but à long terme de Software Heritage est de mettre à disposition
publiquement les objets archivés. Ces objets peuvent être des fichiers
sources simples, mais aussi des tarballs, ou des dépôts.

## Fonctionnement

####

Afin de mettre à disposition au téléchargement un dépôt, Software
Heritage doit être capable de reformer à partir des données
normalisées de sa base de donnée un *bundle* téléchargeable. Le module
qui permet d'effectuer cette opération est le **Vault Software
Heritage** (Voir spécification en annexe \ref{annexe-vault}
p.\pageref{annexe-vault}).

####

En fonction du type de contenu requis, le *bundle* doit contenir des
données différentes et être produit à l'aide de son propre cooker.

####

- **Un répertoire** est compilé simplement en ajoutant les fichiers
  contenus dans une archive compressée.
- **Une tarball** peut être compilée simplement sous la forme d'un
  répertoire compressé.
- la requêtes pour **un dépôt** s'effectue en demandant un commit
  particulier du dépôt. Le *bundle* produit doit contenir tout
  l'historique de commits du dépôt jusqu'à celui demandé. Une telle
  requêtes demande un travail de compilation plus conséquent.

####

Étant donné la durée nécessaire à produire un *bundle*, les requêtes
ne peuvent pas résulter en une attente active de la réponse.

## API de manipulation des bundles

####

Le Vault met à disposition une API Http qui permet d'interagir avec
les composants chargés de la gestion des bundles.

### Requête d'un bundle

####

L'API du **Vault** permet de faire la requête pour un
*bundle*. Lorsque cette requête est reçue, elle est ajoutée dans une
file d'attente et retourne une réponse `201 CREATED`. Cette file
d'attente est consommée par des workers qui produisent les *bundles*.

### Fabrication d'un bundle

####

Les modules chargés de fabriquer les *bundles* sont les **cookers**,
qui consomment les requêtes de la file d'attente et produisent les
bundles associés, qui sont ajoutés dans un cache contenant les bundles
disponibles au téléchargement.


### Téléchargement d'un bundle

####

Lorsqu'un *bundle* est demandé au téléchargement, s'il n'a pas déjà
été compilé par un cooker, l'API retourne une erreur `404 NOT
FOUND`. Sinon, son contenu est envoyé.
