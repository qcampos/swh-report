# Software Heritage

Ce chapitre présente Software Heritage d'un point de vue plus
technique en indiquant l'infrastructure mise en place, et
l'architecture logicielle du projet.

## Data Model

####

Le but de Software Heritage étant de conserver de manière pérenne la
totalité du code source écrit et publiquement accessible, les données
archivées par le logiciel ne doivent jamais être écrasées. Les accès
aux données se font en *append-only*.

####

Lorsqu'un contenu est mis à jour, la version déjà présente dans
Software Heritage n'est pas écrasée, mais une nouvelle entrée est
crée.

### Stockage des fichiers

####

Les données manipulées par Software Heritage sont adressables par
contenu, c'est à dire qu'on peut retrouver leur identifiant (leur
adresse) à partir de leur contenu. Dans le cas de Software Heritage,
nos objets sont identifiés par leur sha1.

####

Les fichiers sources sauvegardés sont stockés sur disque dans une
arborescence de répertoires qui dépend de leur identifiant.

### Base de données

####

La base de données contient les méta-données qui structurent les
fichiers sources en commits, révisions, projets (voir schéma complet
de la base de donnée en annexe \ref{annexe-db} p.\pageref{annexe-db}).


## Infrastructure

####

Software Heritage est un projet ambitieux qui requiert beaucoup de
développement, mais aussi des ressources matérielles conséquentes, en
terme de stockage principalement. Actuellement, deux machines
physiques sont utilisées.

### Serveurs Inria

####

Dans le centre de Roquencourt, dont dépend l'antenne de Paris où est
situé l'équipe Software Heritage se situent les deux machines
physiques du projet, **Louvre** et **Banco**. Louvre est un
hyperviseur hébergeant les machines virtuelles du projet. Banco est la
machine sur laquelle sont stockées les sauvegardes.

####

Les machines virtuelles sont gérées par `puppet`, un utilitaire qui
permet de déployer et mettre à jour automatiquement les paquets requis
pour que la machine puisse remplir son rôle.

#### Uffizi

contient les fichiers sources sauvegardé par Software Heritage. C'est
sur cette machine que fonctionne le `Storage` et sont enregistrés les
fichiers source archivés.

#### Prado

héberge la base de donnée PostgreSQL. Contrairement aux fichiers
source, elle est enregistrée sur des disques durs SSD afin d'accélérer
la vitesse d'exécution des requêtes critiques.

<!-- #### Pergamon -->

<!-- #### Moma -->

<!-- #### Tate -->

#### Getty

fait fonctionner le système de journalisation de Software Heritage qui
enregistre les ajouts à la base. Des clients peuvent ensuite lire ces
informations pour effectuer des opérations particulières sur tous les
contenus nouvellement ajoutés (analyse du contenu, classification,
...)

\label{cloud}

### Ouverture au cloud

####

Software Heritage est né au sein de l'Inria, mais son objectif à long
terme est de devenir une organisation indépendante qui pourra perdurer
*ad vitam aeternam* pour conserver l'héritage logiciel de l'humanité.

####

Software Heritage ne peut donc pas remplir son rôle en n'ayant que des
serveurs chez Inria, tant pour des raisons de sécurité évidente (les
données sont toutes au même endroit) que pour les risques humains ou
administratifs (la disparition éventuelle de l'Inria ne devant pas
mettre en péril le projet).

####

L'objectif est de trouver des partenaires disposés à fournir à
Software Heritage un hébergement qui permettra à Software Heritage de
s'émanciper d'ici quelques années de l'Inria.


## Architecture logicielle

####

Les trois objectifs de Software Heritage conduisent beaucoup le
développement du projet. Cette influence est visible dans les
catégories de modules du projet.

### Loaders (collect)

####

Lorsqu'un code source à été collecté, il peut s'agir d'un projet
encore en développement, qui est donc en train d'évoluer. Le but des
loaders est de parcourir à intervalle régulier des sources pour
vérifier si le code source qu'elles contiennent à été mis à jour.

####

Par exemple, les dépôts git sur Github sont vérifiés à un intervalle
qui dépend de leur fréquence de mise à jour : à chaque passage, si le
dépôt n'a pas été mis à jour, la durée avant la prochaine vérification
est multipliée par deux. A l'inverse, s'il a été mis à jour, la durée
est divisée par deux.

####

Le rôle des loaders est donc de vérifier ces sources, et lorsqu'elles
ont subi des modifications, de télécharger les nouvelles informations
et de les normaliser afin de les mettre dans la base de donnée et le
système de fichiers de Software Heritage.

### Storage et Base de Données (preserve)

####

Le stockage de Software Heritage est conçu pour conserver de manière
pérenne les fichiers sauvegardés. Lorsque les données ont été
téléchargées par les loaders et normalisés afin d'être intégrés dans
le modèle de Software Heritage, les modules `swh.storage` et
`swh.objstorage` sont en charge d'assurer la conservation de
l'intégrité des objets.

####

La base de donnée est sauvegardée régulièrement et les fichiers
sources répliqués sur d'autres serveurs.

#### Vérification du contenu

L'objectif étant de conserver les contenus des fichiers, un tel
système est fortement sensible aux *bit-rote*s, c'est à dire
l'inversion d'un bit sur un disque qui peut subvenir occasionellement.

####

Comme les contenus enregistrés dans Software Heritage sont adressables
par contenu, leur identifiant dépend de leur contenu. Si une erreur
survient et corrompt leur contenu, l'erreur peut-être détéctée.

####

Afin de détécter ce genre d'erreurs, les stockages (Banco et Uffizi)
hébergent aussi un *daemon* qui en arrière plan vérifie l'intégrité
des contenus en séléctionant au hasard des objets à vérifier.

####

Les erreurs ayant une probabilité égale de se produire sur n'importe
quel fichier (récent ou ancien), choisir au hasard la cible des
vérifications donne aux fichiers une probabilité égale d'être
vérifiés. L'heuristique est que, après une période de temps
suffisement longue, tous les fichiers devraient avoir été vérifiés au
moins une fois.


### Web view (share)

####

La *web-view* est l'ensemble des éléments qui permettent d'accéder à
Software Heritage, et donc au contenu sauvegardé, depuis Internet. Le
Site Web de Software Heritage[^site-web], ainsi que l'API
publique[^api-publique-not-yet] constituent cette vue.

[^site-web]: [www.softwareheritage.org](www.softwareheritage.org)

[^api-publique-not-yet]: A la fin de mon stage (Septembre 2016), l'API
    n'est pas publique car l'infrastructure n'est pas suffisante pour
    répondre à une grande quantité de requêtes.

## Travail effectué

####

Le travail effectué lors de mon stage se limite au stockage des
données et à leur préparation pour la distribution. Les chapitres
suivants contiennent des informations plus détaillées sur ces deux
aspects et sur les choix de développement.
